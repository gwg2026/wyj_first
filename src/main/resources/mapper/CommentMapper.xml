<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nxu.dao.CommentMapper">

    <resultMap id="commentResultMap" type="Comment">
        <id property="id" column="id"/>
        <result property="itemId" column="item_id"/>
        <result property="userId" column="user_id"/>
        <result property="content" column="content"/>
        <result property="likes" column="likes"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <!-- 关联用户 -->
        <association property="user" javaType="User">
            <id property="id" column="user_id"/>
            <result property="username" column="username"/>
            <result property="realName" column="real_name"/>
            <result property="studentNo" column="student_no"/>
            <result property="phone" column="phone"/>
            <result property="qq" column="qq"/>
            <result property="wechat" column="wechat"/>
            <result property="email" column="email"/>
        </association>
    </resultMap>

    <!-- 插入评论 -->
    <insert id="insert" parameterType="Comment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO comment (item_id, user_id, content)
        VALUES (#{itemId}, #{userId}, #{content})
    </insert>

    <!-- 根据ID查询评论 -->
    <select id="findById" resultMap="commentResultMap">
        SELECT c.*,
               u.username, u.real_name, u.student_no, u.phone, u.qq, u.wechat, u.email
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.id = #{id}
    </select>

    <!-- 根据失物ID查询评论列表（包含用户信息，按创建时间倒序） -->
    <select id="findByItemId" resultMap="commentResultMap">
        SELECT c.*,
               u.username, u.real_name, u.student_no, u.phone, u.qq, u.wechat, u.email
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.item_id = #{itemId}
        ORDER BY c.create_time DESC
    </select>
    
    <!-- 更新评论点赞数 -->
    <update id="updateLikes">
        UPDATE comment SET likes = likes + #{delta} WHERE id = #{commentId}
    </update>
    
    <!-- 获取评论点赞数 -->
    <select id="getLikes" resultType="int">
        SELECT likes FROM comment WHERE id = #{commentId}
    </select>

    <!-- 根据用户ID查询评论列表 -->
    <select id="findByUserId" resultMap="commentResultMap">
        SELECT c.*,
               u.username, u.real_name, u.student_no, u.phone, u.qq, u.wechat, u.email
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.user_id = #{userId}
        ORDER BY c.create_time DESC
    </select>

    <!-- 删除评论 -->
    <delete id="deleteById">
        DELETE FROM comment WHERE id = #{id}
    </delete>

    <!-- 根据失物ID删除评论 -->
    <delete id="deleteByItemId">
        DELETE FROM comment WHERE item_id = #{itemId}
    </delete>

    <!-- 根据用户ID删除评论 -->
    <delete id="deleteByUserId">
        DELETE FROM comment WHERE user_id = #{userId}
    </delete>

    <!-- 统计评论总数 -->
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM comment
    </select>

    <!-- 根据失物ID统计评论数量 -->
    <select id="countByItemId" resultType="int">
        SELECT COUNT(*) FROM comment WHERE item_id = #{itemId}
    </select>

    <!-- 根据用户ID统计评论数量 -->
    <select id="countByUserId" resultType="int">
        SELECT COUNT(*) FROM comment WHERE user_id = #{userId}
    </select>
</mapper>