<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤±ç‰©è¯¦æƒ…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        .header a { color: white; text-decoration: none; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .detail-card { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .detail-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
        .detail-image { width: 100%; max-width: 600px; border-radius: 10px; margin: 20px 0; }
        .detail-info { margin: 15px 0; }
        .detail-label { font-weight: bold; color: #666; width: 100px; display: inline-block; }
        .detail-value { color: #333; }
        .type-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; margin-right: 10px; color: white; }
        .type-lost { background: #ff6b6b; }
        .type-found { background: #4ecdc4; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; color: white; }
        .status-found { background: #51cf66; }
        .status-lost { background: #ffd43b; color: #333; }
        .contact-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .actions { margin-top: 30px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #51cf66; color: white; }
        .btn-danger { background: #ff6b6b; color: white; }
        .btn-warning { background: #ffd43b; color: #333; }
        .btn-info { background: #74c0fc; color: white; }
        .comment-section { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .scroll-top { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: #667eea; color: white; border: none; border-radius: 50%; cursor: pointer; display: none; transition: all 0.3s ease; z-index: 1000; }
        .scroll-top:hover { background: #5a6fd8; transform: translateY(-3px); }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { position: fixed; top: 0; left: 0; height: 3px; background: #667eea; z-index: 9999; transition: width 0.3s ease; }
        .btn-like:hover, .btn-reply:hover { opacity: 0.8; }
        .comment-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .detail-image:hover { filter: brightness(1.05); transform: scale(1.01); transition: all 0.3s ease; cursor: zoom-in; }
        .related-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .comment-section { animation: slideUp 0.5s ease-out; }
    </style>
</head>
<body>
    <div class="header">
        <a th:href="@{/lost/list}">â† è¿”å›åˆ—è¡¨</a>
    </div>
    <div class="container" th:if="${item != null}" th:attr="data-item-id=${item.id}">
        <div class="detail-card">
            <div class="detail-title">
                <span th:text="${item.title}"></span>
                <span class="type-badge" th:classappend="${item.type == 1 ? 'type-lost' : 'type-found'}"
                      th:text="${item.type == 1 ? 'å¤±ç‰©' : 'æ‹¾ç‰©'}"></span>
                <span class="status-badge" th:classappend="${item.status == 1 ? 'status-found' : 'status-lost'}"
                      th:text="${item.status == 1 ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}"></span>
            </div>
            <div th:if="${item.imageUrl != null}" class="image-container">
                <img th:src="@{${item.imageUrl}}" class="detail-image" alt="å›¾ç‰‡" 
                     onerror="handleImageError(this)" onclick="fullscreenImage()">
                <div class="image-placeholder" style="display: none;" onclick="fullscreenImage()">
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“·</div>
                        <div style="color: #666;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                        <div style="color: #999; font-size: 14px; margin-top: 5px;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                </div>
            </div>
            <div class="detail-info">
                <span class="detail-label">åˆ†ç±»ï¼š</span>
                <span class="detail-value" th:text="${item.category != null ? item.category.name : 'æœªåˆ†ç±»'}"></span>
            </div>
            <div class="detail-info" th:if="${item.lostLocation != null}">
                <span class="detail-label">åœ°ç‚¹ï¼š</span>
                <span class="detail-value" th:text="${item.lostLocation}"></span>
            </div>
            <div class="detail-info" th:if="${item.lostTime != null}">
                <span class="detail-label">æ—¶é—´ï¼š</span>
                <span class="detail-value" th:text="${#dates.format(item.lostTime, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
            <div class="detail-info">
                <span class="detail-label">æè¿°ï¼š</span>
                <div class="detail-value" style="white-space: pre-wrap;" th:text="${item.description}"></div>
            </div>
            <div class="contact-info">
                <h3>è”ç³»æ–¹å¼</h3>
                <div class="detail-info" th:if="${item.user.phone != null}">
                    <span class="detail-label">æ‰‹æœºï¼š</span>
                    <span class="detail-value" th:text="${item.user.phone}"></span>
                </div>
                <div class="detail-info" th:if="${item.user.qq != null}">
                    <span class="detail-label">QQï¼š</span>
                    <span class="detail-value" th:text="${item.user.qq}"></span>
                </div>
                <div class="detail-info" th:if="${item.user.wechat != null}">
                    <span class="detail-label">å¾®ä¿¡ï¼š</span>
                    <span class="detail-value" th:text="${item.user.wechat}"></span>
                </div>
                <div class="detail-info" th:if="${item.user.email != null}">
                    <span class="detail-label">é‚®ç®±ï¼š</span>
                    <span class="detail-value" th:text="${item.user.email}"></span>
                </div>
                <div class="detail-info">
                    <span class="detail-label">å‘å¸ƒè€…ï¼š</span>
                    <span class="detail-value" th:text="${item.user.realName}"></span>
                    <span th:if="${item.user.studentNo != null}">ï¼ˆ<span th:text="${item.user.studentNo}"></span>ï¼‰</span>
                </div>
            </div>
            <div class="detail-info">
                <span class="detail-label">å‘å¸ƒæ—¶é—´ï¼š</span>
                <span class="detail-value" th:text="${#dates.format(item.createTime, 'yyyy-MM-dd HH:mm')}"></span>
                <span style="margin-left: 20px;">æµè§ˆæ¬¡æ•°ï¼š<span th:text="${item.viewCount}"></span></span>
            </div>
            <div class="actions" th:if="${session.user != null and session.user.id == item.userId}">
                <button class="btn btn-success" th:if="${item.status == 0}" onclick="updateStatus(getItemId(), 1)">æ ‡è®°ä¸ºå·²æ‰¾åˆ°</button>
                <button class="btn btn-danger" onclick="deleteItem(getItemId())">åˆ é™¤</button>
            </div>

            <div class="actions" th:if="${session.user != null}">
                <button class="btn btn-primary" onclick="shareItem()">åˆ†äº«</button>
                <button class="btn btn-warning" onclick="reportItem()">ä¸¾æŠ¥</button>
            </div>

            <div class="actions" th:if="${item.imageUrl != null}">
                <button class="btn btn-info" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
                <button class="btn btn-primary" onclick="fullscreenImage()">å…¨å±æŸ¥çœ‹</button>
            </div>

            <!-- æ”¶è—åŠŸèƒ½ -->
            <div class="actions" th:if="${session.user != null and session.user.id != item.userId}">
                <button class="btn btn-warning" onclick="toggleFavorite()">
                    <span id="favorite-text">â™¡ æ”¶è—</span>
                </button>
            </div>

            <!-- ç›¸å…³æ¨è -->
            <div class="related-items" th:if="${relatedItems != null and relatedItems.size() > 0}" style="margin-top: 30px;">
                <h3>ç›¸å…³æ¨è</h3>
                <div class="related-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div th:each="related : ${relatedItems}" class="related-item" 
                         style="background: #f8f9fa; padding: 15px; border-radius: 8px; cursor: pointer;"
                         th:onclick="|window.location.href='/lost/detail/${related.id}'|">
                        <div style="font-weight: bold; margin-bottom: 5px;" th:text="${related.title}"></div>
                        <div style="color: #666; font-size: 14px;">
                            <span th:text="${related.type == 1 ? 'å¤±ç‰©' : 'æ‹¾ç‰©'}"></span> â€¢ 
                            <span th:text="${#dates.format(related.createTime, 'MM-dd HH:mm')}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯„è®ºç³»ç»Ÿ -->
            <div class="comments-section" style="margin-top: 40px;">
                <h3>è¯„è®º (<span id="comment-count">0</span>)</h3>
                <div class="comment-form" th:if="${session.user != null}" style="margin: 20px 0;">
                    <textarea id="comment-content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." 
                              style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                    <button class="btn btn-primary" onclick="submitComment()" style="margin-top: 10px;">å‘è¡¨è¯„è®º</button>
                </div>
                <div class="comment-login" th:if="${session.user == null}" style="margin: 20px 0; text-align: center; color: #666;">
                    è¯·å…ˆ <a href="/user/login" style="color: #667eea;">ç™»å½•</a> åå‘è¡¨è¯„è®º
                </div>
                <div class="comments-list" id="comments-list">
                    <!-- åŠ¨æ€åŠ è½½è¯„è®º -->
                </div>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºæ¨¡æ¿ -->
    <div id="comment-template" style="display: none;">
        <div class="comment-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <div class="comment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div class="comment-author" style="font-weight: bold; color: #333;"></div>
                <div class="comment-time" style="color: #999; font-size: 14px;"></div>
            </div>
            <div class="comment-content-text" style="color: #555; line-height: 1.5;"></div>
        </div>
    </div>
    <script>
        function updateStatus(id, status) {
            if (confirm('ç¡®å®šè¦æ›´æ–°çŠ¶æ€å—ï¼Ÿ')) {
                fetch('/lost/status/' + id, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'status=' + status
                })
                .then(response => {
                    if (response.status === 404) {
                        throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
                });
            }
        }

        function deleteItem(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                fetch('/lost/delete/' + id, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => {
                    if (response.status === 404) {
                        throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('åˆ é™¤æˆåŠŸ');
                        window.location.href = '/lost/my';
                    } else {
                        alert(data.message || 'åˆ é™¤å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
                });
            }
        }

        function shareItem() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    text: 'å‘ç°ä¸€ä¸ªå¤±ç‰©ä¿¡æ¯',
                    url: url
                });
            } else {
                // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(url).then(function() {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }, function(err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('é“¾æ¥ï¼š' + url);
                });
            }
        }

        function reportItem() {
            const reason = prompt('è¯·è¾“å…¥ä¸¾æŠ¥åŸå› ï¼š');
            if (reason && reason.trim()) {
                fetch('/lost/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'itemId=' + getItemId() + '&reason=' + encodeURIComponent(reason.trim())
                })
                .then(response => {
                    if (response.status === 404) {
                        throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('ä¸¾æŠ¥å·²æäº¤ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†');
                    } else {
                        alert(data.message || 'ä¸¾æŠ¥å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ä¸¾æŠ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
                });
            }
        }

        function downloadImage() {
            const imageUrl = '[[${item.imageUrl}]]';
            if (imageUrl) {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = 'å¤±ç‰©å›¾ç‰‡_' + getItemId() + '.jpg';
                link.click();
            }
        }

        function fullscreenImage() {
            const imageUrl = '[[${item.imageUrl}]]';
            if (imageUrl) {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.95);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                // å›¾ç‰‡å®¹å™¨
                const imgContainer = document.createElement('div');
                imgContainer.style.cssText = `
                    position: relative;
                    max-width: 95vw;
                    max-height: 90vh;
                `;
                
                // å›¾ç‰‡
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 90vh;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                    animation: zoomIn 0.3s ease-out;
                `;
                
                // å…³é—­æŒ‰é’®
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = 'âœ•';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: -40px;
                    right: 0;
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    font-size: 24px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    backdrop-filter: blur(10px);
                    transition: all 0.2s ease;
                `;
                
                closeBtn.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(255,255,255,0.3)';
                    this.style.transform = 'scale(1.1)';
                });
                
                closeBtn.addEventListener('mouseleave', function() {
                    this.style.background = 'rgba(255,255,255,0.2)';
                    this.style.transform = 'scale(1)';
                });
                
                closeBtn.onclick = function() {
                    overlay.style.animation = 'fadeOut 0.3s ease-in';
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                    }, 300);
                };
                
                // å›¾ç‰‡ä¿¡æ¯
                const imgInfo = document.createElement('div');
                imgInfo.style.cssText = `
                    position: absolute;
                    bottom: -40px;
                    left: 0;
                    right: 0;
                    text-align: center;
                    color: white;
                    font-size: 14px;
                    text-shadow: 0 2px 5px rgba(0,0,0,0.5);
                `;
                
                imgInfo.innerHTML = `
                    <div>ç‚¹å‡»å›¾ç‰‡å¤–åŒºåŸŸæˆ–æŒ‰ ESC é”®å…³é—­</div>
                `;
                
                // æ·»åŠ é¼ æ ‡æ»šè½®ç¼©æ”¾åŠŸèƒ½
                let scale = 1;
                img.style.transform = `scale(${scale})`;
                
                overlay.addEventListener('wheel', function(e) {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        // æ”¾å¤§
                        scale = Math.min(scale + 0.1, 3);
                    } else {
                        // ç¼©å°
                        scale = Math.max(scale - 0.1, 0.5);
                    }
                    img.style.transform = `scale(${scale})`;
                });
                
                // æ·»åŠ é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeBtn.onclick();
                    }
                });
                
                imgContainer.appendChild(img);
                imgContainer.appendChild(closeBtn);
                imgContainer.appendChild(imgInfo);
                overlay.appendChild(imgContainer);
                document.body.appendChild(overlay);
                
                // ç‚¹å‡»å›¾ç‰‡å¤–éƒ¨å…³é—­
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeBtn.onclick();
                    }
                });
            }
        }
        
        // å›¾ç‰‡æ‚¬åœé¢„è§ˆåŠŸèƒ½
        function initImageHoverPreview() {
            const detailImage = document.querySelector('.detail-image');
            if (!detailImage) return;
            
            let previewOverlay = null;
            let isMouseOverPreview = false;
            
            // åˆ›å»ºé¢„è§ˆå…ƒç´ 
            function createPreviewOverlay() {
                if (previewOverlay) return previewOverlay;
                
                previewOverlay = document.createElement('div');
                previewOverlay.style.cssText = `
                    position: fixed;
                    z-index: 9999;
                    border: 2px solid #667eea;
                    border-radius: 8px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    pointer-events: none;
                    display: none;
                `;
                
                const previewImg = document.createElement('img');
                previewImg.src = detailImage.src;
                previewImg.style.cssText = `
                    max-width: 300px;
                    max-height: 300px;
                    display: block;
                    border-radius: 6px;
                `;
                
                previewOverlay.appendChild(previewImg);
                document.body.appendChild(previewOverlay);
                
                // é¼ æ ‡äº‹ä»¶ç›‘å¬
                previewOverlay.addEventListener('mouseenter', () => {
                    isMouseOverPreview = true;
                });
                
                previewOverlay.addEventListener('mouseleave', () => {
                    isMouseOverPreview = false;
                    previewOverlay.style.display = 'none';
                });
                
                return previewOverlay;
            }
            
            // é¼ æ ‡è¿›å…¥å›¾ç‰‡
            detailImage.addEventListener('mouseenter', function(e) {
                previewOverlay = createPreviewOverlay();
                previewOverlay.style.display = 'block';
            });
            
            // é¼ æ ‡ç§»åŠ¨
            detailImage.addEventListener('mousemove', function(e) {
                if (previewOverlay) {
                    const x = e.clientX + 15;
                    const y = e.clientY + 15;
                    
                    // é˜²æ­¢é¢„è§ˆæ¡†è¶…å‡ºå±å¹•
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    const overlayWidth = 300;
                    const overlayHeight = 300;
                    
                    let left = x;
                    let top = y;
                    
                    if (x + overlayWidth > windowWidth) {
                        left = x - overlayWidth - 30;
                    }
                    
                    if (y + overlayHeight > windowHeight) {
                        top = y - overlayHeight - 30;
                    }
                    
                    previewOverlay.style.left = left + 'px';
                    previewOverlay.style.top = top + 'px';
                }
            });
            
            // é¼ æ ‡ç¦»å¼€å›¾ç‰‡
            detailImage.addEventListener('mouseleave', function() {
                if (previewOverlay && !isMouseOverPreview) {
                    previewOverlay.style.display = 'none';
                }
            });
            
            // ç¡®ä¿é¢„è§ˆå…ƒç´ è¢«ç§»é™¤
            window.addEventListener('beforeunload', function() {
                if (previewOverlay && document.body.contains(previewOverlay)) {
                    document.body.removeChild(previewOverlay);
                }
            });
        }

        // æ”¶è—åŠŸèƒ½
        let isFavorited = false;
        let isLoadingFavorite = false;
        
        // è·å–itemIdçš„å‡½æ•°ï¼Œæ”¯æŒåŠ¨æ€è·å–
        function getItemId() {
            // å°è¯•ä»dataå±æ€§è·å–
            const element = document.querySelector('[data-item-id]');
            if (element) {
                return element.getAttribute('data-item-id');
            }
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å›é»˜è®¤å€¼ï¼ˆç”¨äºé™æ€æµ‹è¯•ï¼‰
            return '1';
        }
        
        // çŠ¶æ€ç®¡ç†å¯¹è±¡
        const StateManager = {
            // ä»localStorageåŠ è½½çŠ¶æ€
            load: function() {
                try {
                    const savedState = localStorage.getItem('lost_detail_state_' + getItemId());
                    if (savedState) {
                        return JSON.parse(savedState);
                    }
                } catch (e) {
                    console.error('Error loading state:', e);
                }
                return {};
            },
            
            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            save: function(state) {
                try {
                    localStorage.setItem('lost_detail_state_' + getItemId(), JSON.stringify(state));
                } catch (e) {
                    console.error('Error saving state:', e);
                }
            },
            
            // è·å–è¯„è®ºçŠ¶æ€
            getCommentsState: function() {
                const state = this.load();
                return state.comments || { lastScrollPosition: 0, expandedComments: {} };
            },
            
            // ä¿å­˜è¯„è®ºçŠ¶æ€
            saveCommentsState: function(commentsState) {
                const state = this.load();
                state.comments = commentsState;
                this.save(state);
            },
            
            // è·å–ç”¨æˆ·åå¥½è®¾ç½®
            getUserPreferences: function() {
                const state = this.load();
                return state.preferences || { 
                    autoLoadComments: true, 
                    commentSortOrder: 'desc',
                    showTimestamps: true 
                };
            },
            
            // ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®
            saveUserPreferences: function(preferences) {
                const state = this.load();
                state.preferences = preferences;
                this.save(state);
            }
        };
        
        function toggleFavorite() {
            if (isLoadingFavorite) return;
            isLoadingFavorite = true;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€æ˜¾ç¤ºåŠ è½½ä¸­
            const btn = document.querySelector('[onclick="toggleFavorite()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span id="favorite-text">å¤„ç†ä¸­...</span>';
            btn.disabled = true;
            
            fetch('/lost/favorite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'itemId=' + getItemId()
            })
            .then(response => {
                if (response.status === 404) {
                    throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                }
                return response.json();
            })
            .then(data => {
                isLoadingFavorite = false;
                btn.disabled = false;
                
                if (data.success) {
                    isFavorited = data.isFavorited;
                    updateFavoriteButton();
                    showMessage(data.message, 'success');
                } else {
                    btn.innerHTML = originalContent;
                    showMessage(data.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            })
            .catch(error => {
                isLoadingFavorite = false;
                btn.disabled = false;
                btn.innerHTML = originalContent;
                console.error('Error:', error);
                showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        function updateFavoriteButton() {
            const btn = document.querySelector('[onclick="toggleFavorite()"]');
            const textSpan = document.getElementById('favorite-text');
            
            // æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨å¯¼è‡´é”™è¯¯
            if (btn && textSpan) {
                if (isFavorited) {
                    textSpan.innerHTML = 'â™¥ å·²æ”¶è—';
                    btn.style.backgroundColor = '#ff6b6b';
                    btn.style.color = 'white';
                } else {
                    textSpan.innerHTML = 'â™¡ æ”¶è—';
                    btn.style.backgroundColor = '#ffd43b';
                    btn.style.color = '#333';
                }
            }
        }
        
        function checkFavoriteStatus() {
            // åªæœ‰å·²ç™»å½•ç”¨æˆ·æ‰æ£€æŸ¥æ”¶è—çŠ¶æ€
            const isLoggedIn = [[${session.user != null}]];
            if (!isLoggedIn) return;
            
            fetch('/lost/favorite/status/' + getItemId())
            .then(response => {
                if (response.status === 404) {
                    throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    isFavorited = data.isFavorited;
                    updateFavoriteButton();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // è¯„è®ºåŠŸèƒ½
        let isSubmittingComment = false;
        
        function submitComment() {
            if (isSubmittingComment) {
                showMessage('è¯„è®ºæ­£åœ¨å‘è¡¨ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }
            
            const content = document.getElementById('comment-content').value.trim();
            if (!content) {
                showMessage('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
                return;
            }
            
            if (content.length > 500) {
                showMessage('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500å­—ç¬¦', 'warning');
                return;
            }
            
            if (content.length < 5) {
                showMessage('è¯„è®ºå†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦', 'warning');
                return;
            }

            isSubmittingComment = true;
            const btn = document.querySelector('[onclick="submitComment()"]');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading-spinner"></span> å‘è¡¨ä¸­...';
            btn.disabled = true;

            fetch('/lost/comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'itemId=' + getItemId() + '&content=' + encodeURIComponent(content)
            })
            .then(response => {
                if (response.status === 404) {
                    throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                }
                return response.json();
            })
            .then(data => {
                // é‡ç½®æäº¤çŠ¶æ€
                isSubmittingComment = false;
                btn.disabled = false;
                btn.textContent = originalText;
                
                if (data.success) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('comment-content').value = '';
                    // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                    loadComments();
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('è¯„è®ºå‘è¡¨æˆåŠŸ', 'success');
                } else {
                    showMessage(data.message || 'è¯„è®ºå¤±è´¥', 'error');
                }
            })
            .catch(error => {
                // ç¡®ä¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿé‡ç½®çŠ¶æ€
                isSubmittingComment = false;
                btn.disabled = false;
                btn.textContent = originalText;
                console.error('Error:', error);
                showMessage('è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        function loadComments() {
            // æ·»åŠ åŠ è½½çŠ¶æ€
            const container = document.getElementById('comments-list');
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">åŠ è½½ä¸­...</div>';
            
            fetch('/lost/comments/' + getItemId())
            .then(response => {
                if (response.status === 404) {
                    throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                }
                // æ£€æŸ¥å“åº”ç±»å‹ï¼Œç¡®ä¿è¿”å›çš„æ˜¯JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    comments = data.comments; // ä¿å­˜è¯„è®ºæ•°æ®
                    displayComments(comments);
                    document.getElementById('comment-count').textContent = data.comments.length;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
            })
            .catch(error => {
                // è¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸</div>
                        <div>åŠ è½½è¯„è®ºå¤±è´¥</div>
                        <div style="font-size: 14px; color: #999; margin-top: 5px;">${error.message}</div>
                        <button onclick="loadComments()" style="margin-top: 10px; padding: 5px 10px; border: 1px solid #ddd; background: white; border-radius: 3px; cursor: pointer;">é‡è¯•</button>
                    </div>
                `;
            });
        }
        
        function displayComments(comments) {
            const container = document.getElementById('comments-list');
            container.innerHTML = '';
            
            // è·å–ç”¨æˆ·åå¥½
            const preferences = StateManager.getUserPreferences();
            
            if (comments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 30px; background: #f8f9fa; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ’¬</div>
                        <div>æš‚æ— è¯„è®ºï¼Œæ¥è¯´ç‚¹ä»€ä¹ˆå§~</div>
                    </div>
                `;
                return;
            }
            
            // æ·»åŠ è¯„è®ºç­›é€‰å’Œæ’åºæ§ä»¶
            const commentsControls = document.createElement('div');
            commentsControls.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding: 10px 15px;
                background: #f8f9fa;
                border-radius: 6px;
            `;
            
            const sortSelect = document.createElement('select');
            sortSelect.id = 'comment-sort';
            sortSelect.style.cssText = 'padding: 5px; border-radius: 4px; border: 1px solid #ddd;';
            sortSelect.innerHTML = `
                <option value="desc" ${preferences.commentSortOrder === 'desc' ? 'selected' : ''}>æœ€æ–°è¯„è®º</option>
                <option value="asc" ${preferences.commentSortOrder === 'asc' ? 'selected' : ''}>æœ€æ—©è¯„è®º</option>
                <option value="likes" ${preferences.commentSortOrder === 'likes' ? 'selected' : ''}>æœ€å¤šç‚¹èµ</option>
            `;
            
            const sortLabel = document.createElement('label');
            sortLabel.textContent = 'æ’åºæ–¹å¼:';
            sortLabel.style.cssText = 'margin-right: 10px; color: #666;';
            
            const filterSelect = document.createElement('select');
            filterSelect.id = 'comment-filter';
            filterSelect.style.cssText = 'padding: 5px; border-radius: 4px; border: 1px solid #ddd;';
            filterSelect.innerHTML = `
                <option value="all">æ‰€æœ‰è¯„è®º</option>
                <option value="withReplies">æœ‰å›å¤çš„</option>
                <option value="popular">çƒ­é—¨è¯„è®º</option>
            `;
            
            const filterLabel = document.createElement('label');
            filterLabel.textContent = 'æ˜¾ç¤º:';
            filterLabel.style.cssText = 'margin-right: 10px; color: #666;';
            
            const leftDiv = document.createElement('div');
            leftDiv.style.cssText = 'display: flex; align-items: center;';
            leftDiv.appendChild(sortLabel);
            leftDiv.appendChild(sortSelect);
            
            const rightDiv = document.createElement('div');
            rightDiv.style.cssText = 'display: flex; align-items: center;';
            rightDiv.appendChild(filterLabel);
            rightDiv.appendChild(filterSelect);
            
            commentsControls.appendChild(leftDiv);
            commentsControls.appendChild(rightDiv);
            
            container.appendChild(commentsControls);
            
            // æ·»åŠ è¯„è®ºå¯¼èˆªæ 
            const commentsNav = document.createElement('div');
            commentsNav.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding: 10px 0;
                border-bottom: 1px solid #eee;
            `;
            
            const navLeft = document.createElement('div');
            navLeft.style.cssText = 'display: flex; gap: 15px;';
            
            const navAll = document.createElement('a');
            navAll.href = '#';
            navAll.id = 'nav-all';
            navAll.className = 'comment-nav-link active';
            navAll.style.cssText = 'color: #667eea; text-decoration: none; font-weight: bold;';
            navAll.textContent = 'å…¨éƒ¨è¯„è®º';
            
            const navReplies = document.createElement('a');
            navReplies.href = '#';
            navReplies.id = 'nav-replies';
            navReplies.className = 'comment-nav-link';
            navReplies.style.cssText = 'color: #666; text-decoration: none;';
            navReplies.textContent = 'æœ‰å›å¤';
            
            const navPopular = document.createElement('a');
            navPopular.href = '#';
            navPopular.id = 'nav-popular';
            navPopular.className = 'comment-nav-link';
            navPopular.style.cssText = 'color: #666; text-decoration: none;';
            navPopular.textContent = 'çƒ­é—¨';
            
            const navRight = document.createElement('div');
            const collapseBtn = document.createElement('button');
            collapseBtn.id = 'collapse-all-replies';
            collapseBtn.style.cssText = 'background: #f8f9fa; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;';
            collapseBtn.textContent = 'æŠ˜å æ‰€æœ‰å›å¤';
            
            navLeft.appendChild(navAll);
            navLeft.appendChild(navReplies);
            navLeft.appendChild(navPopular);
            navRight.appendChild(collapseBtn);
            
            commentsNav.appendChild(navLeft);
            commentsNav.appendChild(navRight);
            
            container.appendChild(commentsNav);
            
            // åˆ›å»ºè¯„è®ºå®¹å™¨
            const commentsContainer = document.createElement('div');
            commentsContainer.className = 'comments-container';
            container.appendChild(commentsContainer);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆç°åœ¨å…ƒç´ å·²ç»åœ¨DOMä¸­ï¼‰
            sortSelect.addEventListener('change', function() {
                preferences.commentSortOrder = this.value;
                StateManager.saveUserPreferences(preferences);
                loadComments();
            });
            
            navAll.addEventListener('click', function(e) {
                e.preventDefault();
                updateNav(this);
                displayFilteredComments(comments, 'all');
            });
            
            navReplies.addEventListener('click', function(e) {
                e.preventDefault();
                updateNav(this);
                displayFilteredComments(comments, 'withReplies');
            });
            
            navPopular.addEventListener('click', function(e) {
                e.preventDefault();
                updateNav(this);
                displayFilteredComments(comments, 'popular');
            });
            
            collapseBtn.addEventListener('click', function() {
                const isCollapsed = this.textContent === 'å±•å¼€æ‰€æœ‰å›å¤';
                this.textContent = isCollapsed ? 'æŠ˜å æ‰€æœ‰å›å¤' : 'å±•å¼€æ‰€æœ‰å›å¤';
                toggleAllReplies(isCollapsed);
            });
            
            // æŒ‰æ’åºæ–¹å¼æ˜¾ç¤ºè¯„è®º
            displayFilteredComments(comments, 'all');
        }
        
        function updateNav(activeLink) {
            document.querySelectorAll('.comment-nav-link').forEach(link => {
                link.classList.remove('active');
                link.style.color = '#666';
                link.style.fontWeight = 'normal';
            });
            
            activeLink.classList.add('active');
            activeLink.style.color = '#667eea';
            activeLink.style.fontWeight = 'bold';
        }
        
        function displayFilteredComments(comments, filter) {
            const container = document.getElementById('comments-list');
            const preferences = StateManager.getUserPreferences();
            
            // è¿‡æ»¤è¯„è®º
            let filteredComments = [...comments];
            
            switch(filter) {
                case 'withReplies':
                    filteredComments = comments.filter(comment => comment.replies && comment.replies.length > 0);
                    break;
                case 'popular':
                    filteredComments = comments.filter(comment => comment.likes && comment.likes > 0)
                        .sort((a, b) => (b.likes || 0) - (a.likes || 0));
                    break;
                default: // all
                    break;
            }
            
            // æ’åºè¯„è®º
            switch(preferences.commentSortOrder) {
                case 'asc':
                    filteredComments.sort((a, b) => new Date(a.createTime) - new Date(b.createTime));
                    break;
                case 'likes':
                    filteredComments.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                    break;
                default: // desc
                    filteredComments.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));
                    break;
            }
            
            // è·å–è¯„è®ºå®¹å™¨
            const commentsContainer = container.querySelector('.comments-container');
            if (!commentsContainer) {
                console.error('Comments container not found');
                return;
            }
            
            // æ¸…ç©ºè¯„è®ºå®¹å™¨
            commentsContainer.innerHTML = '';
            
            // æ˜¾ç¤ºè¯„è®º
            filteredComments.forEach(comment => {
                const commentElement = createCommentElement(comment);
                commentsContainer.appendChild(commentElement);
            });
            
            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            const commentsState = StateManager.getCommentsState();
            commentsState.lastScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            StateManager.saveCommentsState(commentsState);
        }
        
        function toggleAllReplies(expand) {
            const replyContainers = document.querySelectorAll('.comment-replies');
            replyContainers.forEach(container => {
                container.style.display = expand ? 'block' : 'none';
            });
        }
        
        function createCommentElement(comment) {
            const commentDiv = document.createElement('div');
            commentDiv.style.cssText = `
                background: #f8f9fa; 
                padding: 15px; 
                border-radius: 8px; 
                margin: 10px 0;
                border-left: 4px solid #667eea;
                transition: all 0.3s ease;
            `;
            
            // åˆ›å»ºç”¨æˆ·ä¿¡æ¯å¤´éƒ¨
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
            
            const userInfoDiv = document.createElement('div');
            userInfoDiv.style.cssText = 'display: flex; align-items: center;';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.style.cssText = `
                width: 32px; height: 32px; background: #667eea; border-radius: 50%; 
                display: flex; align-items: center; justify-content: center; color: white; 
                font-weight: bold; margin-right: 10px;
            `;
            avatarDiv.textContent = comment.userName ? comment.userName.charAt(0) : 'U';
            
            const userNameDiv = document.createElement('div');
            userNameDiv.style.cssText = 'font-weight: bold; color: #333;';
            userNameDiv.textContent = comment.userName || 'åŒ¿åç”¨æˆ·';
            
            userInfoDiv.appendChild(avatarDiv);
            userInfoDiv.appendChild(userNameDiv);
            
            const timeDiv = document.createElement('div');
            timeDiv.style.cssText = 'color: #999; font-size: 14px;';
            timeDiv.textContent = formatTime(comment.createTime);
            
            headerDiv.appendChild(userInfoDiv);
            headerDiv.appendChild(timeDiv);
            
            // åˆ›å»ºè¯„è®ºå†…å®¹
            const contentDiv = document.createElement('div');
            contentDiv.style.cssText = 'color: #555; line-height: 1.6; word-wrap: break-word;';
            // ä½¿ç”¨å®‰å…¨çš„HTMLè½¬ä¹‰æ˜¾ç¤ºå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œç¬¦æ ¼å¼åŒ–
            contentDiv.innerHTML = formatCommentContent(comment.content);
            
            // åˆ›å»ºæ“ä½œæŒ‰é’®åŒºåŸŸ
            const actionsDiv = document.createElement('div');
            actionsDiv.style.cssText = 'display: flex; align-items: center; margin-top: 8px;';
            
            // ç‚¹èµæŒ‰é’®
            const likeBtn = document.createElement('button');
            likeBtn.className = 'btn-like';
            likeBtn.setAttribute('data-comment-id', comment.id);
            likeBtn.style.cssText = 'background: none; border: none; color: #666; cursor: pointer; padding: 0; margin-right: 15px; display: flex; align-items: center;';
            
            const likeIcon = document.createElement('span');
            likeIcon.className = 'like-icon';
            likeIcon.style.cssText = 'font-size: 18px;';
            likeIcon.textContent = 'ğŸ‘';
            
            const likeCount = document.createElement('span');
            likeCount.className = 'like-count';
            likeCount.style.cssText = 'margin-left: 5px;';
            likeCount.textContent = comment.likes || 0;
            
            likeBtn.appendChild(likeIcon);
            likeBtn.appendChild(likeCount);
            
            // å›å¤æŒ‰é’®
            const replyBtn = document.createElement('button');
            replyBtn.className = 'btn-reply';
            replyBtn.setAttribute('data-comment-id', comment.id);
            replyBtn.style.cssText = 'background: none; border: none; color: #667eea; cursor: pointer; padding: 0; margin-right: 15px;';
            replyBtn.textContent = 'å›å¤';
            
            actionsDiv.appendChild(likeBtn);
            actionsDiv.appendChild(replyBtn);
            
            // åˆ›å»ºå›å¤è¡¨å•å®¹å™¨
            const replyFormContainer = document.createElement('div');
            replyFormContainer.className = 'reply-form-container';
            replyFormContainer.id = `reply-form-${comment.id}`;
            replyFormContainer.style.cssText = 'display: none; margin-top: 10px;';
            
            const textarea = document.createElement('textarea');
            textarea.className = 'reply-content';
            textarea.placeholder = 'å†™ä¸‹ä½ çš„å›å¤...';
            textarea.style.cssText = 'width: 100%; height: 60px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; justify-content: flex-end; margin-top: 5px;';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn-cancel-reply';
            cancelBtn.style.cssText = 'background: #f8f9fa; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px; cursor: pointer;';
            cancelBtn.textContent = 'å–æ¶ˆ';
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn-submit-reply';
            submitBtn.setAttribute('data-comment-id', comment.id);
            submitBtn.style.cssText = 'background: #667eea; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer;';
            submitBtn.textContent = 'å›å¤';
            
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(submitBtn);
            
            replyFormContainer.appendChild(textarea);
            replyFormContainer.appendChild(buttonContainer);
            
            // åˆ›å»ºå›å¤å®¹å™¨
            const repliesContainer = document.createElement('div');
            repliesContainer.className = 'comment-replies';
            repliesContainer.style.cssText = 'margin-top: 10px; padding-left: 15px; border-left: 2px dashed #ddd;';
            
            // å¦‚æœæœ‰å›å¤ï¼Œæ·»åŠ å›å¤å†…å®¹
            if (comment.replies && comment.replies.length > 0) {
                const repliesTitle = document.createElement('div');
                repliesTitle.style.cssText = `
                    margin-top: 15px; 
                    margin-left: 15px; 
                    font-size: 14px; 
                    color: #666; 
                    font-weight: bold;
                    border-bottom: 1px solid #eee;
                    padding-bottom: 5px;
                `;
                repliesTitle.textContent = `å›å¤ (${comment.replies.length})`;
                repliesContainer.appendChild(repliesTitle);
                
                comment.replies.forEach(reply => {
                    const replyElement = createReplyElement(reply);
                    repliesContainer.appendChild(replyElement);
                });
            }
            
            // ç»„è£…è¯„è®ºå…ƒç´ 
            commentDiv.appendChild(headerDiv);
            commentDiv.appendChild(contentDiv);
            commentDiv.appendChild(actionsDiv);
            commentDiv.appendChild(replyFormContainer);
            commentDiv.appendChild(repliesContainer);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            likeBtn.addEventListener('click', () => toggleLike(comment.id, likeBtn));
            replyBtn.addEventListener('click', () => toggleReplyForm(comment.id));
            submitBtn.addEventListener('click', () => submitReply(comment.id));
            cancelBtn.addEventListener('click', () => toggleReplyForm(comment.id));
            
            return commentDiv;
        }
        
        function createReplyElement(reply) {
            // åˆ›å»ºå›å¤å…ƒç´ 
            const replyDiv = document.createElement('div');
            replyDiv.className = 'reply-item';
            replyDiv.style.cssText = 'background: white; padding: 10px; border-radius: 6px; margin: 8px 0;';
            
            // åˆ›å»ºå›å¤å†…å®¹ç»“æ„
            const replyHeader = document.createElement('div');
            replyHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;';
            
            // åˆ›å»ºç”¨æˆ·ä¿¡æ¯
            const userInfo = document.createElement('div');
            userInfo.style.cssText = 'display: flex; align-items: center;';
            
            // åˆ›å»ºå¤´åƒ
            const avatar = document.createElement('div');
            avatar.style.cssText = `
                width: 24px; height: 24px; background: #764ba2; border-radius: 50%;
                display: flex; align-items: center; justify-content: center; color: white;
                font-size: 12px; margin-right: 8px;
            `;
            avatar.textContent = reply.userName ? reply.userName.charAt(0) : 'U';
            
            // åˆ›å»ºç”¨æˆ·å
            const userName = document.createElement('div');
            userName.style.cssText = 'font-weight: bold; color: #333; font-size: 14px;';
            userName.textContent = reply.userName || 'åŒ¿åç”¨æˆ·';
            
            userInfo.appendChild(avatar);
            userInfo.appendChild(userName);
            
            // åˆ›å»ºæ—¶é—´
            const timeElement = document.createElement('div');
            timeElement.style.cssText = 'color: #999; font-size: 12px;';
            timeElement.textContent = formatTime(reply.createTime);
            
            replyHeader.appendChild(userInfo);
            replyHeader.appendChild(timeElement);
            
            // åˆ›å»ºå›å¤å†…å®¹
            const replyContent = document.createElement('div');
            replyContent.style.cssText = 'color: #555; line-height: 1.5; font-size: 14px;';
            // ä½¿ç”¨å®‰å…¨çš„HTMLè½¬ä¹‰æ˜¾ç¤ºå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œç¬¦æ ¼å¼åŒ–
            replyContent.innerHTML = formatCommentContent(reply.content);
            
            replyDiv.appendChild(replyHeader);
            replyDiv.appendChild(replyContent);
            
            return replyDiv;
        }
        
        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            if (form.style.display === 'none') {
                form.style.display = 'block';
                form.querySelector('.reply-content').focus();
            } else {
                form.style.display = 'none';
            }
        }
        
        function toggleLike(commentId, likeBtn) {
            const likeCount = likeBtn.querySelector('.like-count');
            const currentCount = parseInt(likeCount.textContent) || 0;
            
            fetch('/lost/comment/like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'commentId=' + commentId
            })
            .then(response => {
                if (response.status === 404) {
                    throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„å­—æ®µè·å–ç‚¹èµæ•°
                    const newLikeCount = data.likeCount || data.likes || data.data || (currentCount + 1);
                    likeCount.textContent = newLikeCount;
                    
                    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                    likeBtn.querySelector('.like-icon').style.transform = 'scale(1.5)';
                    setTimeout(() => {
                        likeBtn.querySelector('.like-icon').style.transform = 'scale(1)';
                    }, 300);
                    
                    // æ˜¾ç¤ºæ¶ˆæ¯
                    const action = data.action === 'unlike' ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ';
                    showMessage(data.message || `${action}æˆåŠŸï¼Œå½“å‰${newLikeCount}ä¸ªèµ`, 'success');
                } else {
                    showMessage(data.message || 'ç‚¹èµå¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        function submitReply(commentId) {
            const replyContent = document.querySelector(`#reply-form-${commentId} .reply-content`).value.trim();
            
            if (!replyContent) {
                showMessage('è¯·è¾“å…¥å›å¤å†…å®¹', 'warning');
                return;
            }
            
            if (replyContent.length > 300) {
                showMessage('å›å¤å†…å®¹ä¸èƒ½è¶…è¿‡300å­—ç¬¦', 'warning');
                return;
            }
            
            // æ·»åŠ æäº¤çŠ¶æ€æ§åˆ¶
            const submitBtn = document.querySelector(`#reply-form-${commentId} .btn-submit-reply`);
            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> å‘è¡¨ä¸­...';
            submitBtn.disabled = true;
            
            fetch('/lost/comment/reply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'commentId=' + commentId + '&content=' + encodeURIComponent(replyContent)
            })
            .then(response => {
                if (response.status === 404) {
                    throw new Error('APIæ¥å£ä¸å­˜åœ¨');
                }
                return response.json();
            })
            .then(data => {
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                
                if (data.success) {
                    // å…³é—­å›å¤è¡¨å•å¹¶æ¸…ç©ºå†…å®¹
                    toggleReplyForm(commentId);
                    document.querySelector(`#reply-form-${commentId} .reply-content`).value = '';
                    
                    // é‡æ–°åŠ è½½è¯„è®º
                    loadComments();
                    
                    showMessage('å›å¤å‘è¡¨æˆåŠŸ', 'success');
                } else {
                    showMessage(data.message || 'å›å¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                
                console.error('Error:', error);
                showMessage('å›å¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // å®‰å…¨çš„è¯„è®ºå†…å®¹æ ¼å¼åŒ–å‡½æ•°ï¼Œå¤„ç†HTMLè½¬ä¹‰å’Œæ¢è¡Œç¬¦
        function formatCommentContent(content) {
            if (!content) return '';
            
            // å…ˆè¿›è¡ŒHTMLè½¬ä¹‰
            const div = document.createElement('div');
            div.textContent = content;
            let escapedContent = div.innerHTML;
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>æ ‡ç­¾ï¼Œæ”¯æŒå¤šè¡Œæ˜¾ç¤º
            escapedContent = escapedContent.replace(/\n/g, '<br>');
            
            // å¤„ç†è¿ç»­çš„ç©ºæ ¼ï¼ˆé˜²æ­¢å¤šä¸ªç©ºæ ¼è¢«åˆå¹¶ï¼‰
            escapedContent = escapedContent.replace(/  /g, '&nbsp;&nbsp;');
            
            return escapedContent;
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'åˆšåˆš';
            if (minutes < 60) return minutes + 'åˆ†é’Ÿå‰';
            if (hours < 24) return hours + 'å°æ—¶å‰';
            if (days < 7) return days + 'å¤©å‰';
            
            return date.toLocaleDateString();
        }

        // é€šç”¨æ¶ˆæ¯æç¤º
        function showMessage(message, type) {
            // åˆ›å»ºæç¤ºæ¡†
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10001;
                animation: slideIn 0.3s ease-out;
            `;
            
            // è®¾ç½®é¢œè‰²
            switch(type) {
                case 'success':
                    alertDiv.style.backgroundColor = '#51cf66';
                    break;
                case 'error':
                    alertDiv.style.backgroundColor = '#ff6b6b';
                    break;
                case 'warning':
                    alertDiv.style.backgroundColor = '#ffd43b';
                    alertDiv.style.color = '#333';
                    break;
                default:
                    alertDiv.style.backgroundColor = '#667eea';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(alertDiv)) {
                        document.body.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ ä¸€äº›äº¤äº’åŠ¨ç”»
            const cards = document.querySelectorAll('.detail-card');
            cards.forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'opacity 0.5s, transform 0.5s';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            });
            
            // åŠ è½½è¯„è®ºå’Œæ”¶è—çŠ¶æ€
            loadComments();
            checkFavoriteStatus();
            
            // åˆå§‹åŒ–å›¾ç‰‡æ‚¬åœé¢„è§ˆåŠŸèƒ½
            initImageHoverPreview();
            
            // æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
            const commentsState = StateManager.getCommentsState();
            if (commentsState.lastScrollPosition && commentsState.lastScrollPosition > 0) {
                // ä½¿ç”¨requestAnimationFrameç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åå†æ»šåŠ¨
                requestAnimationFrame(() => {
                    window.scrollTo(0, commentsState.lastScrollPosition);
                });
            }
        });
    </script>
        
        <!-- æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’® -->
        <button class="scroll-top" onclick="scrollToTop()" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">â†‘</button>
        
        <!-- åŠ è½½è¿›åº¦æ¡ -->
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        
        <script>
        // å›¾ç‰‡é”™è¯¯å¤„ç†å‡½æ•°
        function handleImageError(img) {
            console.warn('å›¾ç‰‡åŠ è½½å¤±è´¥:', img.src);
            img.style.display = 'none';
            const placeholder = img.nextElementSibling;
            if (placeholder && placeholder.classList.contains('image-placeholder')) {
                placeholder.style.display = 'block';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
                // åˆå§‹åŒ–è¯„è®ºåŒºåŸŸåŠ¨ç”»
                const commentSection = document.querySelector('.comment-section');
                if (commentSection) {
                    commentSection.style.animationDelay = '0.2s';
                }
                
                // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬
                initScrollListener();
                initKeyboardShortcuts();
            });
            
            function initScrollListener() {
                const scrollTopBtn = document.querySelector('.scroll-top');
                const progressBar = document.getElementById('progress-bar');
                
                window.addEventListener('scroll', function() {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    
                    // æ˜¾ç¤º/éšè—æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’®
                    if (scrollTop > 300) {
                        scrollTopBtn.style.display = 'block';
                    } else {
                        scrollTopBtn.style.display = 'none';
                    }
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;
                    progressBar.style.width = Math.min(scrollPercent, 100) + '%';
                });
            }
            
            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function(e) {
                    // Ctrl/Cmd + Enter å¿«é€Ÿæäº¤è¯„è®º
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        const commentContent = document.getElementById('comment-content');
                        if (document.activeElement === commentContent && commentContent.value.trim()) {
                            submitComment();
                        }
                    }
                    
                    // ESC é”®æ¸…ç©ºè¯„è®ºå†…å®¹
                    if (e.key === 'Escape') {
                        const commentContent = document.getElementById('comment-content');
                        if (document.activeElement === commentContent) {
                            commentContent.value = '';
                        }
                    }
                });
            }
            
            function showLoadingProgress() {
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 500);
            }
        </script>
    </body>
</html>

